<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>وازن</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      /* نمط داكن افتراضي (رمادي غامق) */
      --bg:#1f2937;
      --card:#374151;
      --border:#4b5563;
      --text:#f9fafb;
      --accent:#facc15;   /* أصفر للشعار والأزرار البارزة */
      --accent2:#2563eb;  /* أزرق للعناوين والأزرار الثانوية */
      --danger:#dc2626;
      --muted:#9ca3af;
      --inputBg:#111827;
      --inputText:#f3f4f6;

      /* ألوان الرسم البياني */
      --ch1:#2563eb;
      --ch2:#60a5fa;
      --ch3:#facc15;
      --ch4:#fde047;
      --ch5:#9ca3af;
    }

    /* نمط فاتح (للتبديل من الإعدادات) */
    .theme-light{
      --bg:#f3f4f6;
      --card:#ffffff;
      --border:#d1d5db;
      --text:#1e3a8a;
      --accent:#facc15;
      --accent2:#2563eb;
      --danger:#dc2626;
      --muted:#6b7280;
      --inputBg:#f9fafb;
      --inputText:#1f2937;
    }

    *{box-sizing:border-box}
    body{
      margin:0; font-family:'Tajawal', system-ui, Segoe UI, Roboto, sans-serif;
      background:var(--bg); color:var(--text);
      transition: background .2s ease, color .2s ease;
    }
    .container{max-width:1000px; margin:24px auto; padding:0 16px}
    header{display:flex; justify-content:space-between; align-items:center; margin-bottom:16px}
    header h1{font-size:1.8rem; margin:0; color:var(--accent2); font-weight:700}
    .logo{display:flex; align-items:center; gap:10px}
    .coin{
      width:48px; height:48px; border-radius:50%; background:var(--accent);
      display:flex; align-items:center; justify-content:center; font-weight:700;
      color:#1e3a8a; font-size:1.2rem; box-shadow:0 2px 6px rgba(0,0,0,0.12)
    }

    .card{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px}
    .grid{display:grid; gap:12px}
    @media(min-width:900px){ .grid-2{grid-template-columns:1.2fr 1fr} }
    h3{margin:0 0 8px 0; font-size:1.05rem}

    label{font-size:0.9rem; color:var(--muted)}
    input, select, textarea{
      width:100%; padding:10px; border-radius:10px; border:1px solid var(--border);
      background:var(--inputBg); color:var(--inputText);
    }
    input::placeholder, textarea::placeholder{color:#9ca3af}
    textarea{min-height:90px; resize:vertical}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media(max-width:560px){ .row{grid-template-columns:1fr} }

    .actions{display:flex; gap:10px; flex-wrap:wrap}
    button{padding:10px 14px; border:none; border-radius:10px; cursor:pointer; font-weight:700}
    .btn{background:transparent; color:var(--accent2); border:1px solid var(--border)}
    .primary{background:var(--accent2); color:#fff}
    .success{background:var(--accent); color:#111}
    .danger{background:var(--danger); color:#fff}
    .muted{background:transparent; color:var(--muted); border:1px dashed var(--border)}

    .list{margin-top:12px}
    .item{display:grid; grid-template-columns: 1fr 120px 120px 140px auto; gap:10px; align-items:center; padding:10px; border-bottom:1px solid var(--border)}
    @media(max-width:720px){ .item{grid-template-columns: 1fr 100px 110px 110px auto} }
    @media(max-width:560px){ .item{grid-template-columns: 1fr 90px 90px 90px auto; font-size:0.92rem} }
    .item:last-child{border-bottom:none}
    .total{display:flex; justify-content:space-between; align-items:center; margin-top:10px}
    .pill{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px;
      border-radius:999px; background:var(--accent); color:#111; font-size:0.85rem; border:1px solid #eab308
    }
    .empty{color:var(--muted); text-align:center; padding:18px}
    footer{margin-top:18px; color:var(--muted); font-size:0.85rem}

    canvas{margin-top:20px; background:#fff; border:1px solid var(--border); border-radius:12px; padding:8px}

    /* الترس والإعدادات */
    .gear {position: fixed; top: 20px; right: 20px; cursor: pointer; font-size: 24px; color: var(--accent); z-index:1000}
    .settings {position: fixed; top: 0; right: -320px; width: 320px; height: 100%; background: #111827; color: #fff; transition: 0.3s; padding: 20px; z-index:999}
    .settings.open { right: 0; }
    .settings h3{margin-top:0}
    .settings .group{margin-bottom:16px; display:grid; gap:8px}
    .settings .row{grid-template-columns:1fr 1fr}

    /* النجوم للتقييم */
    .stars{user-select:none}
    .stars span { font-size:24px; cursor:pointer; color:#facc15 }
    .stars span.inactive { color:#4b5563 }

    /* شارة الفئة */
    .badge{display:inline-block; padding:4px 8px; border-radius:999px; background:rgba(250,204,21,.18); color:var(--accent); font-weight:700; font-size:0.78rem}
  </style>
</head>

<body>
  <div class="container">
    <header>
      <div class="logo">
        <div class="coin">W</div>
        <h1 id="appTitle">وازن</h1>
      </div>
      <div class="pill"><span id="sumLabel">المجموع:</span> <strong id="grandTotal">0.00</strong> <span id="currency">ريال</span></div>
    </header>

    <div class="grid grid-2">
      <!-- النموذج -->
      <section class="card">
        <h3 id="formTitle">إضافة/تعديل مصروف</h3>
        <form id="expenseForm" class="grid" autocomplete="off">
          <div>
            <label id="lblTitle">اسم المصروف</label>
            <input type="text" id="title" placeholder="مثال: قهوة الصباح" required />
          </div>
          <div class="row">
            <div>
              <label id="lblCategory">الفئة</label>
              <select id="category" required>
                <option value="أكل">أكل</option>
                <option value="مواصلات">مواصلات</option>
                <option value="فواتير">فواتير</option>
                <option value="ترفيه">ترفيه</option>
                <option value="أخرى">أخرى</option>
              </select>
            </div>
            <div>
              <label id="lblDate">التاريخ</label>
              <input type="date" id="date" />
            </div>
          </div>
          <div class="row">
            <div>
              <label id="lblAmount">المبلغ (ريال)</label>
              <input type="number" id="amount" min="0" step="0.01" placeholder="0.00" required />
            </div>
            <div>
              <label id="lblNote">ملاحظة</label>
              <input type="text" id="note" placeholder="اختياري" />
            </div>
          </div>

          <div class="actions">
            <button type="submit" class="success" id="btnSave">حفظ</button>
            <button type="button" id="resetForm" class="muted">تفريغ النموذج</button>
          </div>
        </form>
      </section>

      <!-- التصفية والإحصائيات -->
      <section class="card">
        <h3 id="filterTitle">تصفية وإحصائيات</h3>
        <div class="grid">
          <div class="row">
            <div>
              <label id="lblFilterCat">تصفية بالفئة</label>
              <select id="filterCategory">
                <option value="الكل">الكل</option>
                <option value="أكل">أكل</option>
                <option value="مواصلات">مواصلات</option>
                <option value="فواتير">فواتير</option>
                <option value="ترفيه">ترفيه</option>
                <option value="أخرى">أخرى</option>
              </select>
            </div>
            <div>
              <label id="lblSearch">بحث بالاسم</label>
              <input type="text" id="search" placeholder="اكتب جزء من الاسم" />
            </div>
          </div>

          <!-- إعداد الميزانية لكل فئة -->
          <div class="group">
            <h3 id="budgetTitle">ميزانية الفئات</h3>
            <div class="row">
              <input type="number" min="0" step="0.01" id="budgetFood" placeholder="ميزانية أكل" />
              <input type="number" min="0" step="0.01" id="budgetTransport" placeholder="ميزانية مواصلات" />
            </div>
            <div class="row">
              <input type="number" min="0" step="0.01" id="budgetBills" placeholder="ميزانية فواتير" />
              <input type="number" min="0" step="0.01" id="budgetFun" placeholder="ميزانية ترفيه" />
            </div>
            <div>
              <input type="number" min="0" step="0.01" id="budgetOther" placeholder="ميزانية أخرى" />
            </div>
            <div class="actions">
              <button class="primary" id="saveBudgets">حفظ الميزانية</button>
            </div>
            <div id="budgetWarnings" style="margin-top:8px"></div>
          </div>

          <div class="actions">
            <button id="clearAll" class="danger">حذف كل البيانات</button>
            <button id="exportJson" class="btn">تصدير المصروفات</button>
            <button id="importJson" class="btn">استيراد المصروفات</button>
          </div>
        </div>
      </section>
    </div>

    <!-- القائمة -->
    <section class="card list">
      <div class="item" style="font-weight:700">
        <div id="hdrName">الاسم</div>
        <div id="hdrCat">الفئة</div>
        <div id="hdrDate">التاريخ</div>
        <div id="hdrAmt">المبلغ (ريال)</div>
        <div id="hdrActions">إجراءات</div>
      </div>
      <div id="listContainer"></div>
      <div class="total">
        <span class="pill"><span id="itemsLabel">عناصر:</span> <strong id="count">0</strong></span>
        <span class="pill"><span id="shownTotalLabel">إجمالي المعروض:</span> <strong id="filteredTotal">0.00</strong> <span id="currency2">ريال</span></span>
      </div>
      <canvas id="chart" width="400" height="220"></canvas>
    </section>

    <!-- مربع التقييمات -->
    <section class="card">
      <h3 id="ratingTitle">مربع التقييمات</h3>
      <div class="stars" id="stars">
        <span data-val="1">&#9733;</span>
        <span data-val="2">&#9733;</span>
        <span data-val="3">&#9733;</span>
        <span data-val="4">&#9733;</span>
        <span data-val="5">&#9733;</span>
      </div>
      <textarea id="feedback" placeholder="اكتب ملاحظاتك هنا..." style="width:100%;margin-top:10px"></textarea>
      <div class="actions">
        <button class="success" id="saveRating">حفظ التقييم</button>
        <button class="btn" id="viewRatings">عرض التقييمات</button>
      </div>
      <div id="ratingsList" style="margin-top:10px"></div>
    </section>

    <footer id="footerText">يحفظ تلقائيًا على جهازك. يمكنك التصدير والاستيراد عند الحاجة.</footer>
  </div>

  <!-- أيقونة الترس أعلى يمين -->
  <div class="gear" id="gear">&#9881;</div>

  <!-- لوحة الإعدادات -->
  <div class="settings" id="settings">
    <h3 id="settingsTitle">الإعدادات</h3>
    <div class="group">
      <button id="toggleDark" class="btn">تبديل الوضع الليلي</button>
      <button id="toggleLang" class="btn">تبديل اللغة (عربي/English)</button>
    </div>
    <div class="group">
      <label id="colorSchemeLabel">نمط الألوان</label>
      <div class="row">
        <button class="btn" data-scheme="default">افتراضي</button>
        <button class="btn" data-scheme="warm">دافئ</button>
      </div>
    </div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    /* مفاتيح التخزين */
    const storeKey = 'wazin:expenses:v1';
    const ratingsKey = 'wazin:ratings';
    const settingsKey = 'wazin:settings';
    const budgetsKey = 'wazin:budgets';

    /* حالة التطبيق */
    let expenses = loadJSON(storeKey, []);
    let ratings = loadJSON(ratingsKey, []);
    let settings = loadJSON(settingsKey, { theme:'dark', lang:'ar', scheme:'default' });
    let budgets = loadJSON(budgetsKey, { 'أكل':0, 'مواصلات':0, 'فواتير':0, 'ترفيه':0, 'أخرى':0});
    let editingId = null;
    let chart = null;

    /* عناصر DOM */
    const form = document.getElementById('expenseForm');
    const titleEl = document.getElementById('title');
    const categoryEl = document.getElementById('category');
    const dateEl = document.getElementById('date');
    const amountEl = document.getElementById('amount');
    const noteEl = document.getElementById('note');

    const listContainer = document.getElementById('listContainer');
    const grandTotalEl = document.getElementById('grandTotal');
    const filteredTotalEl = document.getElementById('filteredTotal');
    const countEl = document.getElementById('count');

    const filterCategoryEl = document.getElementById('filterCategory');
    const searchEl = document.getElementById('search');

    const resetFormBtn = document.getElementById('resetForm');
    const clearAllBtn = document.getElementById('clearAll');
    const exportJsonBtn = document.getElementById('exportJson');
    const importJsonBtn = document.getElementById('importJson');

    const gear = document.getElementById('gear');
    const settingsPanel = document.getElementById('settings');
    const toggleDarkBtn = document.getElementById('toggleDark');
    const toggleLangBtn = document.getElementById('toggleLang');

    const budgetInputs = {
      'أكل': document.getElementById('budgetFood'),
      'مواصلات': document.getElementById('budgetTransport'),
      'فواتير': document.getElementById('budgetBills'),
      'ترفيه': document.getElementById('budgetFun'),
      'أخرى': document.getElementById('budgetOther'),
    };
    const saveBudgetsBtn = document.getElementById('saveBudgets');
    const budgetWarningsEl = document.getElementById('budgetWarnings');

    const starsEls = document.querySelectorAll('#stars span');
    const feedbackEl = document.getElementById('feedback');
    const saveRatingBtn = document.getElementById('saveRating');
    const viewRatingsBtn = document.getElementById('viewRatings');
    const ratingsListEl = document.getElementById('ratingsList');

    /* أدوات مساعدة */
    function loadJSON(key, def){
      try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : def; }
      catch(e){ return def; }
    }
    function saveJSON(key, val){
      try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){}
    }
    const uid = () => Math.random().toString(36).slice(2,9);
    const fmtDate = (d) => d ? new Date(d).toLocaleDateString(document.documentElement.lang === 'ar' ? 'ar-SA' : 'en-GB') : '-';
    const fmtAmount = (n) => Number(n || 0).toFixed(2);
    function escapeHtml(s){
      return String(s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    /* التهيئة: ثيم/لغة/مخطط */
    initTheme();
    initLang();
    initBudgetsUI();
    render();

    /* أحداث النموذج */
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const amountVal = Number(amountEl.value);
      const titleVal = titleEl.value.trim();
      if(!titleVal || isNaN(amountVal)){ return; }

      const payload = {
        id: editingId || uid(),
        title: titleVal,
        category: categoryEl.value,
        date: dateEl.value || new Date().toISOString().split('T')[0], // تاريخ تلقائي عند الإدخال
        amount: amountVal,
        note: (noteEl.value || '').trim()
      };

      if(editingId){
        expenses = expenses.map(x => x.id === editingId ? payload : x);
        editingId = null;
      } else {
        expenses.push(payload);
      }
      saveJSON(storeKey, expenses);
      form.reset();
      render();
      titleEl.focus();
    });

    resetFormBtn.addEventListener('click', () => {
      form.reset();
      editingId = null;
    });

    /* إجراءات القائمة (تعديل/حذف) */
    listContainer.addEventListener('click', (e) => {
      const editId = e.target.getAttribute('data-edit');
      const delId = e.target.getAttribute('data-del');

      if(editId){
        const x = expenses.find(i => i.id === editId);
        if(x){
          editingId = x.id;
          titleEl.value = x.title;
          categoryEl.value = x.category;
          dateEl.value = x.date || '';
          amountEl.value = x.amount;
          noteEl.value = x.note || '';
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      }
      if(delId){
        if(confirm(settings.lang === 'ar' ? 'تأكيد حذف العنصر؟' : 'Confirm delete?')){
          expenses = expenses.filter(i => i.id !== delId);
          saveJSON(storeKey, expenses);
          render();
        }
      }
    });

    /* تصفية وبحث */
    filterCategoryEl.addEventListener('change', render);
    searchEl.addEventListener('input', render);

    /* حذف كل البيانات */
    clearAllBtn.addEventListener('click', () => {
      const msg = settings.lang === 'ar' ? 'سيتم حذف كل البيانات نهائيًا. متابعة؟' : 'All data will be deleted. Continue?';
      if(confirm(msg)){
        expenses = [];
        saveJSON(storeKey, expenses);
        render();
      }
    });

    /* تصدير/استيراد المصروفات */
    exportJsonBtn.addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(expenses, null, 2)], {type: 'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'expenses.json';
      a.click();
    });

    importJsonBtn.addEventListener('click', async () => {
      const input = document.createElement('input');
      input.type = 'file'; input.accept = 'application/json';
      input.onchange = async () => {
        const file = input.files?.[0];
        if(!file) return;
        try{
          const text = await file.text();
          const data = JSON.parse(text);
          if(Array.isArray(data)){
            expenses = data.filter(x => x && x.id && typeof x.amount !== 'undefined' && x.title);
            saveJSON(storeKey, expenses);
            render();
          } else {
            alert(settings.lang === 'ar' ? 'ملف غير صالح.' : 'Invalid file.');
          }
        }catch(err){
          alert(settings.lang === 'ar' ? 'حدث خطأ في قراءة الملف.' : 'Error reading file.');
        }
      };
      input.click();
    });

    /* إعدادات: فتح/إغلاق */
    gear.addEventListener('click', ()=> settingsPanel.classList.toggle('open'));

    /* تبديل الوضع الليلي/العادي */
    toggleDarkBtn.addEventListener('click', ()=>{
      settings.theme = (settings.theme === 'dark') ? 'light' : 'dark';
      saveJSON(settingsKey, settings);
      initTheme();
      settingsPanel.classList.remove('open');
    });

    /* تبديل اللغة (عربي/English) */
    toggleLangBtn.addEventListener('click', ()=>{
      settings.lang = (settings.lang === 'ar') ? 'en' : 'ar';
      saveJSON(settingsKey, settings);
      initLang();
      render();
      settingsPanel.classList.remove('open');
    });

    /* تبديل مخطط الألوان */
    settingsPanel.addEventListener('click', (e)=>{
      const scheme = e.target.getAttribute('data-scheme');
      if(!scheme) return;
      if(scheme === 'default'){ applyScheme('default'); }
      if(scheme === 'warm'){ applyScheme('warm'); }
      settingsPanel.classList.remove('open');
    });

    /* ميزانيات الفئات */
    saveBudgetsBtn.addEventListener('click', ()=>{
      Object.keys(budgetInputs).forEach(cat=>{
        budgets[cat] = Number(budgetInputs[cat].value || 0);
      });
      saveJSON(budgetsKey, budgets);
      renderBudgetWarnings(); // عرض التنبيهات فورًا
    });

    /* التقييمات */
    let currentRating = 0;
    starsEls.forEach(star=>{
      star.addEventListener('click', ()=>{
        currentRating = Number(star.dataset.val);
        starsEls.forEach(s=> s.classList.add('inactive'));
        for(let i=0;i<currentRating;i++){ starsEls[i].classList.remove('inactive'); }
      });
    });

    saveRatingBtn.addEventListener('click', ()=>{
      ratings.push({stars:currentRating, note: feedbackEl.value.trim(), ts: Date.now()});
      saveJSON(ratingsKey, ratings);
      feedbackEl.value = '';
      currentRating = 0;
      starsEls.forEach(s=> s.classList.add('inactive'));
      alert(settings.lang === 'ar' ? 'تم حفظ التقييم' : 'Rating saved');
    });

    viewRatingsBtn.addEventListener('click', ()=>{
      ratingsListEl.innerHTML = ratings.length ? ratings.map(r=>{
        const date = new Date(r.ts).toLocaleString(settings.lang === 'ar' ? 'ar-SA' : 'en-GB');
        const stars = '★'.repeat(r.stars) + '☆'.repeat(5 - r.stars);
        return `<div style="padding:8px;border-bottom:1px solid var(--border)">
                  <div style="font-weight:700">${stars}</div>
                  <div style="color:var(--muted)">${escapeHtml(r.note || '')}</div>
                  <div style="font-size:0.8rem;color:var(--muted)">${date}</div>
                </div>`;
      }).join('') : (settings.lang === 'ar' ? 'لا توجد تقييمات بعد.' : 'No ratings yet.');
    });

    /* وظائف العرض */
    function render(){
      const grandTotal = expenses.reduce((sum, x) => sum + Number(x.amount || 0), 0);
      grandTotalEl.textContent = fmtAmount(grandTotal);

      const q = (searchEl.value || '').trim().toLowerCase();
      const cat = filterCategoryEl.value;
      const filtered = expenses.filter(x => {
        const byCat = cat === 'الكل' ? true : x.category === cat;
        const byText = !q ? true : (x.title.toLowerCase().includes(q) || (x.note||'').toLowerCase().includes(q));
        return byCat && byText;
      });

      const filteredTotal = filtered.reduce((sum, x) => sum + Number(x.amount || 0), 0);
      filteredTotalEl.textContent = fmtAmount(filteredTotal);
      countEl.textContent = filtered.length;

      // القائمة
      listContainer.innerHTML = '';
      if(filtered.length === 0){
        listContainer.innerHTML = `<div class="empty">${settings.lang === 'ar' ? 'لا توجد عناصر مطابقة.' : 'No matching items.'}</div>`;
      } else {
        for(const x of filtered){
          const row = document.createElement('div');
          row.className = 'item';
          row.innerHTML = `
            <div>
              <div style="font-weight:700">${escapeHtml(x.title)}</div>
              <div style="color:var(--muted); font-size:0.85rem">${escapeHtml(x.note || '')}</div>
            </div>
            <div><span class="badge">${escapeHtml(x.category)}</span></div>
            <div>${fmtDate(x.date)}</div>
            <div>${fmtAmount(x.amount)}</div>
            <div style="display:flex; gap:8px; justify-content:flex-end">
              <button class="btn" data-edit="${x.id}">${settings.lang === 'ar' ? 'تعديل' : 'Edit'}</button>
              <button class="danger" data-del="${x.id}">${settings.lang === 'ar' ? 'حذف' : 'Delete'}</button>
            </div>
          `;
          listContainer.appendChild(row);
        }
      }

      // الرسم البياني حسب الفئة
      renderChart(filtered);

      // تنبيهات الميزانية
      renderBudgetWarnings();
    }

    function buildChartData(items){
      const cats = ['أكل', 'مواصلات', 'فواتير', 'ترفيه', 'أخرى'];
      const totals = cats.map(cat => items
        .filter(x => x.category === cat)
        .reduce((sum, x) => sum + Number(x.amount || 0), 0)
      );
      return { labels: cats, data: totals };
    }

    function renderChart(items){
      const ctx = document.getElementById('chart').getContext('2d');
      const { labels, data } = buildChartData(items);
      if(chart){ chart.destroy(); }
      chart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels,
          datasets: [{
            data,
            backgroundColor: [getVar('--ch1'), getVar('--ch2'), getVar('--ch3'), getVar('--ch4'), getVar('--ch5')],
            borderColor: '#ffffff',
            borderWidth: 2
          }]
        },
        options: {
          plugins: {
            legend: { position: 'bottom', labels: { boxWidth: 16 } },
            tooltip: { callbacks: {
              label: (ctx) => `${ctx.label}: ${fmtAmount(ctx.parsed)} ${settings.lang === 'ar' ? 'ريال' : 'SAR'}`
            }}
          }
        }
      });
    }

    function renderBudgetWarnings(){
      const cats = Object.keys(budgets);
      const totals = {};
      cats.forEach(cat => {
        totals[cat] = expenses.filter(e=>e.category===cat).reduce((s,x)=>s+Number(x.amount||0),0);
      });
      const warnings = cats.filter(cat => budgets[cat] > 0 && totals[cat] > budgets[cat])
        .map(cat => {
          const over = fmtAmount(totals[cat] - budgets[cat]);
          return settings.lang === 'ar'
            ? `تنبيه: تجاوزت ميزانية "${cat}" بمقدار ${over} ريال.`
            : `Alert: "${cat}" budget exceeded by ${over} SAR.`;
        });
      budgetWarningsEl.innerHTML = warnings.length
        ? warnings.map(w=>`<div style="color:#fca5a5; padding:6px 8px; border:1px solid #fca5a5; border-radius:8px; margin-top:6px">${escapeHtml(w)}</div>`).join('')
        : '';
    }

    /* ثيم/لغة/مخطط ألوان */
    function initTheme(){
      document.body.classList.toggle('theme-light', settings.theme === 'light');
    }
    function getVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
    function applyScheme(scheme){
      settings.scheme = scheme;
      saveJSON(settingsKey, settings);
      if(scheme === 'default'){
        document.documentElement.style.setProperty('--accent2', '#2563eb');
        document.documentElement.style.setProperty('--ch1', '#2563eb');
        document.documentElement.style.setProperty('--ch2', '#60a5fa');
        document.documentElement.style.setProperty('--ch3', '#facc15');
        document.documentElement.style.setProperty('--ch4', '#fde047');
        document.documentElement.style.setProperty('--ch5', '#9ca3af');
      } else if(scheme === 'warm'){
        document.documentElement.style.setProperty('--accent2', '#b45309');
        document.documentElement.style.setProperty('--ch1', '#b45309');
        document.documentElement.style.setProperty('--ch2', '#f59e0b');
        document.documentElement.style.setProperty('--ch3', '#facc15');
        document.documentElement.style.setProperty('--ch4', '#fcd34d');
        document.documentElement.style.setProperty('--ch5', '#d1d5db');
      }
    }

    function initLang(){
      const ar = settings.lang === 'ar';
      document.documentElement.lang = ar ? 'ar' : 'en';
      document.documentElement.dir  = ar ? 'rtl' : 'ltr';

      // عناوين ونصوص
      document.getElementById('appTitle').textContent = ar ? 'وازن' : 'Wazin';
      document.getElementById('sumLabel').textContent = ar ? 'المجموع:' : 'Total:';
      document.getElementById('currency').textContent = ar ? 'ريال' : 'SAR';
      document.getElementById('currency2').textContent = ar ? 'ريال' : 'SAR';

      document.getElementById('formTitle').textContent = ar ? 'إضافة/تعديل مصروف' : 'Add/Edit Expense';
      document.getElementById('lblTitle').textContent = ar ? 'اسم المصروف' : 'Expense name';
      document.getElementById('lblCategory').textContent = ar ? 'الفئة' : 'Category';
      document.getElementById('lblDate').textContent = ar ? 'التاريخ' : 'Date';
      document.getElementById('lblAmount').textContent = ar ? 'المبلغ (ريال)' : 'Amount (SAR)';
      document.getElementById('lblNote').textContent = ar ? 'ملاحظة' : 'Note';
      document.getElementById('btnSave').textContent = ar ? 'حفظ' : 'Save';
      document.getElementById('resetForm').textContent = ar ? 'تفريغ النموذج' : 'Reset form';

      document.getElementById('filterTitle').textContent = ar ? 'تصفية وإحصائيات' : 'Filter & Stats';
      document.getElementById('lblFilterCat').textContent = ar ? 'تصفية بالفئة' : 'Filter by category';
      document.getElementById('lblSearch').textContent = ar ? 'بحث بالاسم' : 'Search by name';

      document.getElementById('budgetTitle').textContent = ar ? 'ميزانية الفئات' : 'Category Budgets';
      budgetInputs['أكل'].placeholder = ar ? 'ميزانية أكل' : 'Food budget';
      budgetInputs['مواصلات'].placeholder = ar ? 'ميزانية مواصلات' : 'Transport budget';
      budgetInputs['فواتير'].placeholder = ar ? 'ميزانية فواتير' : 'Bills budget';
      budgetInputs['ترفيه'].placeholder = ar ? 'ميزانية ترفيه' : 'Fun budget';
      budgetInputs['أخرى'].placeholder = ar ? 'ميزانية أخرى' : 'Other budget';
      document.getElementById('saveBudgets').textContent = ar ? 'حفظ الميزانية' : 'Save budgets';

      document.getElementById('clearAll').textContent = ar ? 'حذف كل البيانات' : 'Delete all';
      document.getElementById('exportJson').textContent = ar ? 'تصدير المصروفات' : 'Export expenses';
      document.getElementById('importJson').textContent = ar ? 'استيراد المصروفات' : 'Import expenses';

      document.getElementById('hdrName').textContent = ar ? 'الاسم' : 'Name';
      document.getElementById('hdrCat').textContent = ar ? 'الفئة' : 'Category';
      document.getElementById('hdrDate').textContent = ar ? 'التاريخ' : 'Date';
      document.getElementById('hdrAmt').textContent = ar ? 'المبلغ (ريال)' : 'Amount (SAR)';
      document.getElementById('hdrActions').textContent = ar ? 'إجراءات' : 'Actions';
      document.getElementById('itemsLabel').textContent = ar ? 'عناصر:' : 'Items:';
      document.getElementById('shownTotalLabel').textContent = ar ? 'إجمالي المعروض:' : 'Shown total:';

      document.getElementById('ratingTitle').textContent = ar ? 'مربع التقييمات' : 'Ratings';
      feedbackEl.placeholder = ar ? 'اكتب ملاحظاتك هنا...' : 'Write your notes here...';
      document.getElementById('saveRating').textContent = ar ? 'حفظ التقييم' : 'Save rating';
      document.getElementById('viewRatings').textContent = ar ? 'عرض التقييمات' : 'View ratings';

      document.getElementById('settingsTitle').textContent = ar ? 'الإعدادات' : 'Settings';
      document.getElementById('toggleDark').textContent = ar ? 'تبديل الوضع الليلي' : 'Toggle dark mode';
      document.getElementById('toggleLang').textContent = ar ? 'تبديل اللغة (عربي/English)' : 'Toggle language (Arabic/English)';
      document.getElementById('colorSchemeLabel').textContent = ar ? 'نمط الألوان' : 'Color scheme';

      document.getElementById('footerText').textContent = ar
        ? 'يحفظ تلقائيًا على جهازك. يمكنك التصدير والاستيراد عند الحاجة.'
        : 'Saved locally on your device. You can export/import when needed.';
    }

    function initBudgetsUI(){
      Object.keys(budgetInputs).forEach(cat=>{
        budgetInputs[cat].value = budgets[cat] || 0;
      });
    }

    /* مساعد تغيير المخطط */
    applyScheme(settings.scheme);

    /* نهاية السكربت */
  </script>
</body>
</html>

